<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIP-üò∏ OCR Scanner - Emoji Address Decoder</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 150px;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .btn-camera {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-upload {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-scan {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .video-container {
            position: relative;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
            display: none;
        }

        .video-container.active {
            display: block;
        }

        video {
            width: 100%;
            display: block;
        }

        .capture-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            border: 5px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .capture-btn:hover {
            transform: translateX(-50%) scale(1.1);
        }

        .preview-container {
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        .preview-container.active {
            display: block;
        }

        .preview-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .results.active {
            display: block;
        }

        .result-section {
            margin: 15px 0;
        }

        .result-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            padding: 15px;
            background: white;
            border-radius: 8px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            border-left: 4px solid #667eea;
        }

        .emoji-display {
            font-size: 1.5em;
            line-height: 1.8;
        }

        .error {
            color: #f5576c;
            padding: 15px;
            background: #ffe0e0;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success {
            color: #00b894;
            padding: 15px;
            background: #d4edda;
            border-radius: 8px;
            margin: 10px 0;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .info-box h3 {
            color: #2196F3;
            margin-bottom: 10px;
        }

        canvas {
            display: none;
        }

        input[type="file"] {
            display: none;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            flex: 1;
            padding: 10px;
            background: white;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç BIP-üò∏ OCR Scanner</h1>
        <p class="subtitle">Scan emoji addresses and decode them to Bitcoin addresses</p>

        <div class="info-box">
            <h3>How to use:</h3>
            <p>1. Display an emoji address on another device or print it<br>
            2. Click "Start Camera" or "Upload Image" to capture the emoji address<br>
            3. Click "Scan & Decode" to extract and convert to Bitcoin address</p>
        </div>

        <div class="input-section">
            <div class="button-group">
                <button class="btn-camera" onclick="startCamera()">üì∏ Start Camera</button>
                <button class="btn-upload" onclick="document.getElementById('fileInput').click()">üìÅ Upload Image</button>
                <button class="btn-scan" onclick="scanImage()" id="scanBtn" disabled>üîç Scan & Decode</button>
            </div>
        </div>

        <div class="video-container" id="videoContainer">
            <video id="video" autoplay playsinline></video>
            <button class="capture-btn" onclick="captureImage()"></button>
        </div>

        <div class="preview-container" id="previewContainer">
            <img id="preview" class="preview-image" alt="Preview">
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <div class="results" id="results">
            <div class="result-section">
                <div class="result-label">Raw OCR Text</div>
                <div class="result-value" id="rawText"></div>
            </div>

            <div class="result-section">
                <div class="result-label">Extracted Emoji</div>
                <div class="result-value emoji-display" id="extractedEmoji"></div>
            </div>

            <div class="result-section">
                <div class="result-label">Decoded Bitcoin Address</div>
                <div class="result-value" id="decodedAddress"></div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">Emoji Found</div>
                    <div class="stat-value" id="emojiCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Confidence</div>
                    <div class="stat-value" id="confidence">0%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Processing Time</div>
                    <div class="stat-value" id="processingTime">0s</div>
                </div>
            </div>
        </div>

        <canvas id="canvas"></canvas>
        <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
    </div>

    <script>
        // Base58 to Emoji mapping (from data/base58_emoji_mapping.json)
        const EMOJI_TO_BASE58 = {
            "üßî": "1", "üçä": "3", "üíÆ": "X", "ü´Ö": "e", "üëß": "Y",
            "ü§¥": "f", "üï∏Ô∏è": "i", "üèµÔ∏è": "F", "üßë": "u", "üëµ": "H",
            "‚úä": "p", "üë©": "J", "üë®": "Z", "üßí": "r", "üçà": "L",
            "üßì": "b", "üë≤": "n", "üë¥": "9", "ü•ù": "P", "ü§∂": "A",
            "üçé": "D", "üë±": "m", "üê£": "a", "üñêÔ∏è": "c", "üçè": "M",
            "üë¶": "v", "ü™≤": "E", "‚úã": "4", "üêµ": "y", "ü¶™": "Q",
            "ü´ë": "S", "üò∂": "N", "üê∂": "o", "üëã": "W", "üçë": "q",
            "ü¶î": "K", "üêû": "z", "ü§ö": "5", "üññ": "t", "ü´µ": "B",
            "üë∏": "x", "üçÅ": "G", "ü§´": "2", "üå∏": "T", "ü§≤": "R",
            "üçê": "k", "üë∂": "8", "üå≥": "s", "ü¶ª": "g", "üôà": "6",
            "ü´•": "j", "üëè": "C", "üëÇ": "w", "ü™¥": "d", "üò¶": "V",
            "ü´∞": "h", "üóØÔ∏è": "U", "üëä": "7"
        };

        let stream = null;
        let capturedImage = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                document.getElementById('videoContainer').classList.add('active');
                document.getElementById('previewContainer').classList.remove('active');
            } catch (error) {
                alert('Error accessing camera: ' + error.message);
            }
        }

        function captureImage() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            capturedImage = canvas.toDataURL('image/png');
            document.getElementById('preview').src = capturedImage;
            document.getElementById('previewContainer').classList.add('active');
            document.getElementById('videoContainer').classList.remove('active');
            document.getElementById('scanBtn').disabled = false;

            // Stop camera
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    capturedImage = e.target.result;
                    document.getElementById('preview').src = capturedImage;
                    document.getElementById('previewContainer').classList.add('active');
                    document.getElementById('videoContainer').classList.remove('active');
                    document.getElementById('scanBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        function extractEmojis(text) {
            // Extract all emoji from text
            const emojiRegex = /[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu;
            const emojis = text.match(emojiRegex) || [];

            // Filter to only include emojis in our mapping
            return emojis.filter(emoji => emoji in EMOJI_TO_BASE58);
        }

        function decodeEmojiToBase58(emojis) {
            return emojis.map(emoji => EMOJI_TO_BASE58[emoji] || '?').join('');
        }

        async function scanImage() {
            if (!capturedImage) {
                alert('Please capture or upload an image first');
                return;
            }

            const startTime = Date.now();
            document.getElementById('progressContainer').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.getElementById('scanBtn').disabled = true;

            try {
                const worker = await Tesseract.createWorker();

                await worker.loadLanguage('eng');
                await worker.initialize('eng');

                // Set parameters for better emoji recognition
                await worker.setParameters({
                    tessedit_char_whitelist: '',
                    preserve_interword_spaces: '1',
                });

                const { data } = await worker.recognize(capturedImage, {
                    rectangle: undefined,
                }, {
                    logger: (m) => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            document.getElementById('progressFill').style.width = progress + '%';
                            document.getElementById('progressFill').textContent = progress + '%';
                        }
                    }
                });

                await worker.terminate();

                const processingTime = ((Date.now() - startTime) / 1000).toFixed(2);

                // Extract emojis from the recognized text
                const extractedEmojis = extractEmojis(data.text);
                const decodedAddress = decodeEmojiToBase58(extractedEmojis);

                // Display results
                document.getElementById('rawText').textContent = data.text || '(No text detected)';
                document.getElementById('extractedEmoji').textContent = extractedEmojis.join(' ') || '(No emoji detected)';
                document.getElementById('decodedAddress').textContent = decodedAddress || '(No valid address decoded)';

                document.getElementById('emojiCount').textContent = extractedEmojis.length;
                document.getElementById('confidence').textContent = Math.round(data.confidence) + '%';
                document.getElementById('processingTime').textContent = processingTime + 's';

                document.getElementById('progressContainer').classList.remove('active');
                document.getElementById('results').classList.add('active');
                document.getElementById('scanBtn').disabled = false;

                // Validation message
                if (extractedEmojis.length > 0 && decodedAddress && !decodedAddress.includes('?')) {
                    const successMsg = document.createElement('div');
                    successMsg.className = 'success';
                    successMsg.textContent = `‚úÖ Successfully decoded ${extractedEmojis.length} emoji characters!`;
                    document.getElementById('results').insertBefore(successMsg, document.getElementById('results').firstChild);
                } else if (extractedEmojis.length === 0) {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'error';
                    errorMsg.textContent = '‚ö†Ô∏è No emoji characters detected in the image. Try a clearer image or better lighting.';
                    document.getElementById('results').insertBefore(errorMsg, document.getElementById('results').firstChild);
                } else {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'error';
                    errorMsg.textContent = '‚ö†Ô∏è Some emoji characters could not be mapped to Base58. They may not be part of the BIP-üò∏ character set.';
                    document.getElementById('results').insertBefore(errorMsg, document.getElementById('results').firstChild);
                }

            } catch (error) {
                console.error('OCR Error:', error);
                alert('Error during scanning: ' + error.message);
                document.getElementById('progressContainer').classList.remove('active');
                document.getElementById('scanBtn').disabled = false;
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
